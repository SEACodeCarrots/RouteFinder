<!-- RouteBoxer code sample from http://google-maps-utility-library-v3.googlecode.com/svn/trunk/routeboxer/docs/examples.html -->

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Google Maps JavaScript API Search Along a Route Example</title>
    <script src="http://maps.google.com/maps/api/js?v=3.exp&signed_in=true&libraries=places" type="text/javascript"></script>
    <script src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/routeboxer/src/RouteBoxer.js" type="text/javascript"></script>
    <script type="text/javascript">

    var map = null;
    var boxpolys = null;
    var directions = null;
    var routeBoxer = null;
    var distance = null; // km
    var placesService = null; //for Places functionality
    var infowindow = new google.maps.InfoWindow();

    function initialize() {
      // Default the map view to the continental U.S.
      var mapOptions = {
        center: new google.maps.LatLng(37.09024, -95.712891),
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        zoom: 4
      };

      map = new google.maps.Map(document.getElementById("map"), mapOptions);
      routeBoxer = new RouteBoxer(); // Class that returns a list of LatLngBounds (boxes) along a route.

      directionService = new google.maps.DirectionsService(); // Class for getting directions from one place to another.
      directionsRenderer = new google.maps.DirectionsRenderer({ map: map }); // Class that renders the directions on screen.

      placesService = new google.maps.places.PlacesService(map); // Class for searching for places of interest within a LatLngBounds scope.
      infowindow = new google.maps.InfoWindow(); // The window that pops up when you click on a place marker. Gives details about the place.
    }
    
    function route() {
      // Clear any previous route boxes from the map
      clearBoxes();
      
      // Convert the distance to box around the route from miles to km
      distance = parseFloat(document.getElementById("distance").value) * 1.609344;
      
      var request = {
        origin: document.getElementById("from").value,
        destination: document.getElementById("to").value,
        travelMode: google.maps.DirectionsTravelMode.DRIVING
      }
      
      // Make the directions request
      directionService.route(request, function(result, status) {
        if (status == google.maps.DirectionsStatus.OK) {
          directionsRenderer.setDirections(result);
          
          // Box around the overview path of the first route
          var path = result.routes[0].overview_path;
          var boxes = routeBoxer.box(path, distance);
          drawBoxes(boxes);
        } else {
          alert("Directions query failed: " + status);
        }
      });
    }
    
    // Draw the array of boxes as polylines on the map
    // TODO: This may be where we should start searching for places of interest.
    function drawBoxes(boxes) {
      boxpolys = new Array(boxes.length);
      for (var i = 0; i < boxes.length; i++) {
        boxpolys[i] = new google.maps.Rectangle({
          bounds: boxes[i],
          fillOpacity: 0,
          strokeOpacity: 1.0,
          strokeColor: '#000000',
          strokeWeight: 1,
          map: map
        });
          
        var request = {
        bounds: boxes[i],
        types: ['store'] // TODO: Make this customizable. Add more places types.
        };
          
        placesService.nearbySearch(request, callback);

      }
    }
    
    function callback(results, status) {
        if (status == google.maps.places.PlacesServiceStatus.OK) {
            for (var i = 0; i < results.length; i++) {
            var place = results[i];
            createMarker(results[i]);
            }
        }
    }

    function createMarker(place) {
        var placeLoc = place.geometry.location;

        // If this place type has an icon (e.g., a shopping bag icon to represent type=store),
        // use the icon as the marker. Otherwise, we'll use default marker.
        var image = null;
        if (place.icon) {
            var image = new google.maps.MarkerImage(
                      place.icon, new google.maps.Size(25, 25),
                      new google.maps.Point(0, 0), new google.maps.Point(10, 20),
                      new google.maps.Size(25, 25));
        }

        var marker = new google.maps.Marker({
            map: map,
            icon: image,
            position: place.geometry.location
        });

        // Add an event listener for the "click" event so that when user clicks on this marker,
        // we will show details about this place.
        google.maps.event.addListener(marker, 'click', function () {
            var request = {
                reference: place.reference
            };

            // Now make the request to get more details.
            placesService.getDetails(request, function (place, status) {
                if (status == google.maps.places.PlacesServiceStatus.OK) {
                    var contentStr = '<p> Name: ' + place.name + '</p>';
                    contentStr += '<p> Type: ' + place.types + '</p>'; // TODOD: Add more details? Style them?
                    infowindow.setContent(contentStr);
                    infowindow.open(map, marker);
                } else {
                    var contentStr = "No Result, status=" + status;
                    infowindow.setContent(contentStr);
                    infowindow.open(map, marker);
                }
            });
        });
    }

    // Clear boxes currently on the map
    function clearBoxes() {
      if (boxpolys != null) {
        for (var i = 0; i < boxpolys.length; i++) {
          boxpolys[i].setMap(null);
        }
      }
      boxpolys = null;
    }    
  </script>
  <style>
    #map {
      border: 1px solid black;
    }
  </style>
  </head>

  <body onload="initialize();">
    <div id="map" style="width: 800px; height: 600px;"></div>
    Box within at least <input type="text" id="distance" value="30" size="2">miles
    of the route from <input type="text" id="from" value="denver"/>
    to <input type="text" id="to" value="dallas"/>
    <input type="submit" onclick="route()"/>
  </body>
</html>